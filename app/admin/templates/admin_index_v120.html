{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Chat Console {% if sim_mode %}<span class="muted">(Sim mode)</span>{% else %}<span class="muted">(Live token set)</span>{% endif %}</h2>
  <form method="post" action="/admin/api/sim/chat" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <input name="user" placeholder="username" required />
    <input name="text" placeholder="message (e.g., !sound tada)" required />
    <button>Send</button>
  </form>
  <div class="muted" style="margin-top:6px">Tip: Try <code>!help</code></div>

  <h3 style="margin-top:16px">Inject Event</h3>
  <form method="post" action="/admin/api/sim/event" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <select name="kind">
      <option value="follow">follow</option>
      <option value="sub">sub</option>
      <option value="tip">tip</option>
      <option value="dropin">drop-in</option>
    </select>
    <input name="user" placeholder="username" />
    <input name="months" type="number" step="1" value="1" style="width:80px" />
    <input name="tokens" type="number" step="1" value="10" style="width:100px" />
    <button>Inject</button>
  </form>
</section>

<section class="card">
  <h2>Overlay SFX — Quick Test</h2>
  <form id="playtest" hx-post="/admin/api/play-test" hx-target="#play-result" hx-swap="innerHTML">
    <button type="submit">▶️ Play First Sound</button>
  </form>
  <div id="play-result" class="muted"></div>
</section>

<section class="card">
  <h2>Wheel — Quick Spin Tester <span id="qs-ws" class="muted">(overlay bus: connecting…)</span></h2>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
    <label>Duration (sec)
      <input id="qs-dur" type="number" min="1" max="15" value="4" style="width:6rem;">
    </label>
    <label>Rain density
      <input id="qs-den" type="number" min="0" max="200" value="38" style="width:7rem;">
    </label>
    <label>Shake (ms)
      <input id="qs-shk" type="number" min="0" max="3000" value="900" style="width:7rem;">
    </label>
    <label>Confetti
      <input id="qs-con" type="number" min="0" max="400" value="120" style="width:7rem;">
    </label>
    <label>Text width (ch)
      <input id="qs-tw" type="number" min="30" max="90" value="70" style="width:7rem;">
    </label>
    <label>Prize text
      <input id="qs-txt" type="text" value="100 Points!" style="width:18rem;">
    </label>
    <label>Image URL (optional)
      <input id="qs-img" type="text" placeholder="/admin/static/wheel/question.png" style="width:22rem;">
    </label>
  </div>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end; margin-top:10px">
    <label><input id="qs-audio" type="checkbox"> Also trigger SFX overlay</label>
    <label title="Filename in ./sounds (name or URL)"><small>Start SFX</small>
      <input id="qs-sfx-start" type="text" value="wheel_start.wav" style="width:12rem;">
    </label>
    <label title="Filename in ./sounds (name or URL)"><small>Loop SFX</small>
      <input id="qs-sfx-loop" type="text" value="wheel_loop.wav" style="width:12rem;">
    </label>
    <label title="Filename in ./sounds (name or URL)"><small>Win SFX</small>
      <input id="qs-sfx-win" type="text" value="wheel_win.wav" style="width:12rem;">
    </label>
  </div>

  <div style="display:flex; gap:10px; margin-top:14px;">
    <button id="qs-run" disabled>Run Quick Spin</button>
    <button id="qs-stop">Stop Rain / Loop</button>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const dur = $('qs-dur'), den = $('qs-den'), shk = $('qs-shk'),
          con = $('qs-con'), tw  = $('qs-tw'),  txt = $('qs-txt'), img = $('qs-img');
    const withAudio = $('qs-audio'), sfxStart = $('qs-sfx-start'), sfxLoop = $('qs-sfx-loop'), sfxWin = $('qs-sfx-win');
    const runBtn = $('qs-run'), stopBtn = $('qs-stop'), wsHud = $('qs-ws');

    // WebSocket to overlay bus (same origin)
    const wsURL = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/overlay/ws';
    let ws;

    function wsSend(obj){
      if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj));
    }

    function connect(){
      try {
        ws = new WebSocket(wsURL);
        ws.onopen = () => { wsHud.textContent = '(overlay bus: connected)'; runBtn.disabled = false; };
        ws.onclose = () => { wsHud.textContent = '(overlay bus: disconnected)'; runBtn.disabled = true; setTimeout(connect, 1200); };
        ws.onerror = () => { wsHud.textContent = '(overlay bus: error)'; runBtn.disabled = true; };
        ws.onmessage = () => { /* no-op, admin sender only */ };
      } catch(e) {
        wsHud.textContent = '(overlay bus: failed)';
      }
    }
    connect();

    function playStart(){
      // optional SFX: one-shot start + loop
      if (!withAudio.checked) return;
      if (sfxStart.value)  wsSend({ type:'sfx', action:'play',       name: sfxStart.value });
      if (sfxLoop.value)   wsSend({ type:'sfx', action:'loop-start',  name: sfxLoop.value  });
    }
    function stopLoop(){
      wsSend({ type:'wheel', action:'rain-stop' });
      if (withAudio.checked) wsSend({ type:'sfx', action:'loop-stop' });
    }
    function playWin(){
      if (!withAudio.checked) return;
      if (sfxWin.value) wsSend({ type:'sfx', action:'play', name: sfxWin.value });
    }

    runBtn.addEventListener('click', () => {
      if (!ws || ws.readyState !== 1) return;

      const durationSec   = Math.max(1, Math.min(15, Number(dur.value || 4)));
      const density       = Number(den.value || 38);
      const shakeMs       = Number(shk.value || 900);
      const confettiCount = Number(con.value || 120);
      const textMaxWidth  = Number(tw.value  || 70);
      const prizeText     = String(txt.value || '');
      const imageUrl      = String(img.value || '');

      // start
      wsSend({ type:'wheel', action:'rain-start', density, ...(imageUrl ? {image: imageUrl} : {}) });
      playStart();

      // stop + reveal
      setTimeout(() => {
        stopLoop();
        playWin();
        // slight delay to ensure loop-stop propagates before reveal
        setTimeout(() => {
          wsSend({ type:'wheel', action:'reveal',
            ...(imageUrl ? {image: imageUrl} : {}),
            prize: prizeText,
            confettiCount, shakeMs, textMaxWidth
          });
        }, 120);
      }, durationSec * 1000);
    });

    stopBtn.addEventListener('click', stopLoop);
  })();
  </script>
</section>

<section class="card">
  <h2>Users & Points</h2>
  <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
    <div style="flex:1; min-width:260px;">
      <h3>Create User</h3>
      <form method="post" action="/admin/api/users/create">
        <input name="name" placeholder="username" required />
        <button type="submit">Create</button>
      </form>
    </div>
    <div style="flex:2; min-width:320px;">
      <h3>Recent Users</h3>
      {% if users %}
      <table>
        <thead><tr><th>User</th><th>Balance</th><th>Grant</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.name }}</td>
            <td>{{ u.points.balance if u.points else 0 }}</td>
            <td>
              <form method="post" action="/admin/api/users/grant" style="display:flex; gap:6px; align-items:center;">
                <input type="hidden" name="user_id" value="{{ u.id }}" />
                <input name="amount" type="number" step="1" style="width:90px" placeholder="amount" required />
                <input name="reason" style="width:160px" placeholder="reason" />
                <button>Grant</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="muted">No users yet. Create one above or use the Chat Console.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2>Redeems</h2>
  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div style="flex:1; min-width:320px;">
      <h3>Add / Update Redeem</h3>
      <form method="post" action="/admin/api/redeems/upsert">
        <input name="key" placeholder="key (e.g., tts)" required />
        <input name="display_name" placeholder="Display Name" required />
        <input name="cost" type="number" step="1" placeholder="Cost" required />
        <label><input type="checkbox" name="enabled" value="1" checked /> Enabled</label>
        <button type="submit">Save</button>
      </form>
    </div>
    <div style="flex:2; min-width:360px;">
      <h3>Registered</h3>
      {% if redeems %}
      <table>
        <thead><tr><th>Key</th><th>Name</th><th>Cost</th><th>Enabled</th><th>Actions</th></tr></thead>
        <tbody>
        {% for r in redeems %}
          <tr>
            <td><code>{{ r.key }}</code></td>
            <td>{{ r.display_name }}</td>
            <td>{{ r.cost }}</td>
            <td>{{ 'Yes' if r.enabled else 'No' }}</td>
            <td>
              <form method="post" action="/admin/api/redeems/toggle" style="display:inline-block">
                <input type="hidden" name="key" value="{{ r.key }}" />
                <input type="hidden" name="enabled" value="{{ 0 if r.enabled else 1 }}" />
                <button>{{ 'Disable' if r.enabled else 'Enable' }}</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="muted">No redeems found.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2>Queue</h2>
  <div id="queue-list" hx-get="/admin/api/queue" hx-trigger="load, every 2s" hx-swap="innerHTML">
    Loading…
  </div>
  <template id="qtpl">
    <table>
      <thead><tr><th>ID</th><th>Kind</th><th>Status</th><th>Created</th><th>Payload</th></tr></thead>
      <tbody></tbody>
    </table>
  </template>
  <script>
  (function(){
    const container = document.getElementById('queue-list');
    const render = (data) => {
      const tpl = document.getElementById('qtpl');
      const root = tpl.content.cloneNode(true);
      const tbody = root.querySelector('tbody');
      for (const it of (data.items||[])){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.id}</td><td>${it.kind}</td><td>${it.status}</td><td>${it.created_at}</td><td><code>${JSON.stringify(it.payload)}</code></td>`;
        tbody.appendChild(tr);
      }
      container.innerHTML = '';
      container.appendChild(root);
    };
    document.addEventListener('htmx:afterOnLoad', (ev)=>{
      try{ render(JSON.parse(ev.detail.xhr.responseText)); }catch(e){ /* ignore */ }
    });
  })();
  </script>
</section>

<section class="card">
  <h2>Available Sounds</h2>
  {% if sounds %}
    <ul class="list">
      {% for s in sounds %}
      <li>
        <code>{{ s }}</code>
        <button hx-post="/admin/api/play?name={{ s }}" hx-target="#play-result" hx-swap="innerHTML">Play</button>
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No sound files found in <code>./sounds</code>. Drop .wav/.mp3/.ogg files there.</p>
  {% endif %}
</section>
{% endblock %}