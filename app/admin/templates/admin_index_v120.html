{% extends "base.html" %}
{% block content %}

<style>
  :root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #1e293b;
    --border: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
  }

  * { box-sizing: border-box; }
  body { background: var(--bg-primary); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  
  /* Layout */
  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .header h1 { margin: 0; font-size: 28px; }
  
  /* Tabs */
  .tabs { display: flex; gap: 8px; border-bottom: 2px solid var(--border); margin-bottom: 24px; }
  .tab { padding: 12px 24px; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 15px; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
  .tab:hover { color: var(--text-primary); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  /* Cards */
  .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
  .card h2 { margin: 0 0 8px 0; font-size: 18px; font-weight: 600; }
  .card p { margin: 0 0 16px 0; color: var(--text-secondary); font-size: 14px; }
  
  /* Grid */
  .grid { display: grid; gap: 20px; }
  .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
  .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
  .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
  
  /* Stats */
  .stat-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
  .stat-value { font-size: 32px; font-weight: 700; color: var(--text-primary); }
  
  /* Forms */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary); }
  .form-inline { display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap; }
  .form-inline .form-group { margin-bottom: 0; flex: 1; min-width: 150px; }
  
  input, select, textarea { 
    width: 100%; 
    background: var(--bg-primary); 
    border: 1px solid var(--border); 
    color: var(--text-primary); 
    padding: 10px 12px; 
    border-radius: 8px; 
    font-size: 14px;
    transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
  input[type="checkbox"] { width: auto; }
  
  /* Buttons */
  .btn { 
    padding: 10px 16px; 
    border: none; 
    border-radius: 8px; 
    font-size: 14px; 
    font-weight: 500; 
    cursor: pointer; 
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { filter: brightness(1.1); }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { filter: brightness(1.1); }
  .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-sm { padding: 6px 12px; font-size: 13px; }
  
  /* Tables */
  .table-container { overflow-x: auto; }
  .table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .table th { 
    text-align: left; 
    padding: 12px; 
    background: var(--bg-primary); 
    color: var(--text-secondary); 
    font-weight: 600; 
    font-size: 13px; 
    text-transform: uppercase; 
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
  }
  .table td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .table tr:hover { background: var(--bg-primary); }
  
  /* Badges */
  .badge { 
    display: inline-block; 
    padding: 4px 8px; 
    border-radius: 6px; 
    font-size: 12px; 
    font-weight: 600; 
  }
  .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
  .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
  .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
  
  /* Status */
  .status { color: var(--text-muted); font-size: 13px; margin-left: 8px; }
  
  /* Utilities */
  .muted { color: var(--text-muted); }
  .text-sm { font-size: 13px; }
  .mt-2 { margin-top: 16px; }
  .mb-0 { margin-bottom: 0; }
  code { background: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-size: 13px; color: var(--accent); }
</style>

<div class="container">
  <div class="header">
    <h1>üéÆ Pixel Bot Admin</h1>
    <div class="muted">v2.1.0</div>
  </div>

  <!-- Stats Dashboard -->
  <div class="grid grid-4" style="margin-bottom: 30px;">
    <div class="stat-box">
      <div class="stat-label">Total Users</div>
      <div class="stat-value">{{ users|length }}</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Redeems</div>
      <div class="stat-value">{{ redeems|length }}</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Items</div>
      <div class="stat-value">{{ items|length }}</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Status</div>
      <div class="stat-value" style="font-size: 20px; color: var(--success);">‚óè Online</div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tabs">
    <button class="tab active" data-tab="redeems">üéØ Redeems</button>
    <button class="tab" data-tab="users">üë• Users & Points</button>
    <button class="tab" data-tab="tts">üéôÔ∏è TTS Lines</button>
    <button class="tab" data-tab="tools">üõ†Ô∏è Tools</button>
    <button class="tab" data-tab="audit">üìä Audit Logs</button>
  </div>

  <!-- Tab: Redeems -->
  <div class="tab-content active" id="tab-redeems">
    <div class="grid grid-2">
      <!-- Add/Edit Redeem -->
      <div class="card">
        <h2>Add / Edit Redeem</h2>
        <p>Create new redeems or update existing ones by using the same key.</p>
        <form method="post" action="/admin/api/redeems/upsert" id="redeem-form">
          <div class="form-group">
            <label class="form-label">Key *</label>
            <input name="key" id="redeem-key" placeholder="e.g., tts, pixel, sound" required />
          </div>
          <div class="form-group">
            <label class="form-label">Display Name *</label>
            <input name="display_name" id="redeem-display" placeholder="e.g., Text-to-Speech" required />
          </div>
          <div class="form-inline">
            <div class="form-group">
              <label class="form-label">Cost (Points) *</label>
              <input name="cost" id="redeem-cost" type="number" step="1" min="0" placeholder="25" required />
            </div>
            <div class="form-group">
              <label class="form-label">Cooldown (Seconds)</label>
              <input name="cooldown_s" id="redeem-cooldown" type="number" step="1" min="0" placeholder="10" value="0" />
            </div>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" name="enabled" id="redeem-enabled" value="1" checked />
              <span>Enabled</span>
            </label>
          </div>
          <button type="submit" class="btn btn-primary">üíæ Save Redeem</button>
          <button type="button" class="btn btn-secondary" id="clear-redeem-form">Clear</button>
          <span class="status" id="redeem-status"></span>
        </form>
      </div>

      <!-- Registered Redeems -->
      <div class="card">
        <h2>Registered Redeems</h2>
        <p>Click a redeem to edit, or delete ones you don't need.</p>
        {% if redeems %}
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Cost</th>
                <th>Cooldown</th>
                <th>Status</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in redeems %}
              <tr>
                <td>
                  <strong>{{ r.display_name }}</strong><br>
                  <code class="muted">{{ r.key }}</code>
                </td>
                <td>{{ r.cost }} pts</td>
                <td>{{ r.cooldown_s if r.cooldown_s is defined else 0 }}s</td>
                <td>
                  {% if r.enabled %}
                    <span class="badge badge-success">Active</span>
                  {% else %}
                    <span class="badge badge-danger">Disabled</span>
                  {% endif %}
                </td>
                <td>
                  <button class="btn btn-sm btn-primary edit-redeem" 
                    data-key="{{ r.key }}"
                    data-display="{{ r.display_name }}"
                    data-cost="{{ r.cost }}"
                    data-cooldown="{{ r.cooldown_s if r.cooldown_s is defined else 0 }}"
                    data-enabled="{{ 1 if r.enabled else 0 }}">
                    ‚úèÔ∏è Edit
                  </button>
                  <form method="post" action="/admin/api/redeems/delete" style="display:inline-block" class="delete-redeem-form">
                    <input type="hidden" name="key" value="{{ r.key }}" />
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete {{ r.key }}?')">
                      üóëÔ∏è Delete
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="muted">No redeems configured yet. Create one using the form.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Tab: Users & Points -->
  <div class="tab-content" id="tab-users">
    <div class="card">
      <h2>Create New User</h2>
      <form method="post" action="/admin/api/users/create" class="form-inline">
        <div class="form-group">
          <label class="form-label">Username *</label>
          <input name="name" placeholder="Enter username" required />
        </div>
        <button type="submit" class="btn btn-success">‚ûï Create User</button>
      </form>
    </div>

    <div class="card">
      <h2>Manage Users ({{ users|length }} total)</h2>
      {% if users %}
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>User</th>
              <th>Points</th>
              <th>XP / Level</th>
              <th>Grant Points</th>
              <th>Adjust XP</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td>
                <strong>{{ u.name }}</strong><br>
                <span class="muted text-sm">ID: {{ u.id }} ‚Ä¢ Last seen: {{ u.last_seen.strftime('%Y-%m-%d %H:%M') if u.last_seen else 'Never' }}</span>
              </td>
              <td>
                {% if u.points %}
                  <strong>{{ u.points.balance }}</strong> pts
                {% else %}
                  <span class="muted">0 pts</span>
                {% endif %}
              </td>
              <td>
                {% set x = xp_map.get(u.id) %}
                {% if x %}
                  <strong>Level {{ x.level }}</strong><br>
                  <span class="muted text-sm">{{ x.total_xp }} XP</span>
                {% else %}
                  <span class="muted">No XP</span>
                {% endif %}
              </td>
              <td>
                <form method="post" action="/admin/api/users/grant" class="form-inline">
                  <input type="hidden" name="user_id" value="{{ u.id }}" />
                  <input name="amount" type="number" step="1" style="width:100px" placeholder="Amount" required />
                  <button class="btn btn-sm btn-success">Grant</button>
                </form>
              </td>
              <td>
                <form method="post" action="/admin/api/users/xp/adjust" class="form-inline">
                  <input type="hidden" name="user_id" value="{{ u.id }}" />
                  <input name="delta" type="number" step="1" style="width:100px" placeholder="+/-" required />
                  <button class="btn btn-sm btn-primary">Adjust</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="muted">No users yet. Create one above.</p>
      {% endif %}
    </div>
  </div>

  <!-- Tab: TTS Lines -->
  <div class="tab-content" id="tab-tts">
    <div class="card">
      <h2>TTS Lines Editor</h2>
      <p>Edit spin and prize announcement lines. Backups are auto-created in <code>./data/backups</code>.</p>
      <form id="tts-lines-form" method="post" action="/admin/api/tts-lines/save">
        <div class="grid grid-2">
          <div>
            <h3>Spin Lines</h3>
            <textarea id="spin_lines" name="spin_lines" rows="12" placeholder="One line per entry..."></textarea>
            <div id="spin_backups" class="muted text-sm mt-2"></div>
          </div>
          <div>
            <h3>Prize Lines</h3>
            <textarea id="prize_lines" name="prize_lines" rows="12" placeholder="One line per entry..."></textarea>
            <div id="prize_backups" class="muted text-sm mt-2"></div>
          </div>
        </div>
        <div style="margin-top: 16px;">
          <button type="submit" class="btn btn-success">üíæ Save Lines</button>
          <span class="status" id="tts-save-result"></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Tab: Tools -->
  <div class="tab-content" id="tab-tools">
    <div class="card">
      <h2>Quick Spin Tester</h2>
      <p>Test the prize wheel without spending points or enforcing cooldowns.</p>
      <form id="quickspin" method="post" action="/admin/api/spin/quick" class="form-inline">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input name="user" placeholder="Tester" value="Tester" />
        </div>
        <button type="submit" class="btn btn-primary">üé∞ Queue Spin</button>
        <span id="quickspin-result" class="status"></span>
      </form>
    </div>
  </div>

  <!-- Tab: Audit Logs -->
  <div class="tab-content" id="tab-audit">
    <div class="grid grid-2">
      <div class="card">
        <h2>Points Audit Log</h2>
        <div class="form-inline" style="margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label">User</label>
            <select id="audit_user">
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Limit</label>
            <input id="audit_limit" type="number" value="50" style="width:100px" />
          </div>
          <button type="button" id="audit_load" class="btn btn-primary">Load</button>
          <span id="audit_status" class="status"></span>
        </div>
        <div class="table-container">
          <table class="table" id="audit_table">
            <thead>
              <tr><th>ID</th><th>Type</th><th>Delta</th><th>Reason</th><th>Date</th></tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="muted">Click "Load" to view transactions.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>XP Audit Log</h2>
        <div class="form-inline" style="margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label">User</label>
            <select id="xp_audit_user">
              {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Limit</label>
            <input id="xp_audit_limit" type="number" value="50" style="width:100px" />
          </div>
          <button type="button" id="xp_audit_load" class="btn btn-primary">Load</button>
          <span id="xp_audit_status" class="status"></span>
        </div>
        <div class="table-container">
          <table class="table" id="xp_audit_table">
            <thead>
              <tr><th>ID</th><th>Delta</th><th>Reason</th><th>Source</th><th>Date</th></tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="muted">Click "Load" to view transactions.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Tab Switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// Edit Redeem
document.querySelectorAll('.edit-redeem').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('redeem-key').value = btn.dataset.key;
    document.getElementById('redeem-display').value = btn.dataset.display;
    document.getElementById('redeem-cost').value = btn.dataset.cost;
    document.getElementById('redeem-cooldown').value = btn.dataset.cooldown;
    document.getElementById('redeem-enabled').checked = btn.dataset.enabled === '1';
    document.getElementById('redeem-key').focus();
  });
});

// Clear Redeem Form
document.getElementById('clear-redeem-form').addEventListener('click', () => {
  document.getElementById('redeem-form').reset();
});

// Delete Redeem Forms
document.querySelectorAll('.delete-redeem-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    try {
      const r = await fetch(form.action, { method: 'POST', body: fd });
      if (r.ok) location.reload();
      else alert('Error deleting redeem');
    } catch (err) {
      alert('Error: ' + err);
    }
  });
});

// Quick Spin
document.getElementById('quickspin').addEventListener('submit', async (e) => {
  e.preventDefault();
  const out = document.getElementById('quickspin-result');
  out.textContent = 'queuing‚Ä¶';
  const fd = new FormData(e.target);
  try {
    const r = await fetch(e.target.action, { method: 'POST', body: fd });
    const j = await r.json();
    out.textContent = j.ok ? ('‚úÖ Queued #' + j.queue_id) : '‚ùå Error';
  } catch (err) {
    out.textContent = '‚ùå Error';
  }
});

// TTS Lines
(async function() {
  async function loadTTS() {
    const r = await fetch('/admin/api/tts-lines/get');
    const j = await r.json();
    if (!j.ok) return;
    document.getElementById('spin_lines').value = j.spin_lines || '';
    document.getElementById('prize_lines').value = j.prize_lines || '';
    document.getElementById('spin_backups').textContent = 'Backups: ' + (j.spin_backups || []).join(', ');
    document.getElementById('prize_backups').textContent = 'Backups: ' + (j.prize_backups || []).join(', ');
  }

  document.getElementById('tts-lines-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const out = document.getElementById('tts-save-result');
    out.textContent = 'saving‚Ä¶';
    const fd = new FormData(e.target);
    try {
      const r = await fetch(e.target.action, { method: 'POST', body: fd });
      const j = await r.json();
      out.textContent = j.ok ? '‚úÖ Saved' : ('‚ùå ' + (j.detail || 'Error'));
      await loadTTS();
    } catch (err) {
      out.textContent = '‚ùå Error';
    }
  });

  loadTTS();
})();

// Audit Logs
document.getElementById('audit_load').addEventListener('click', async () => {
  const userId = document.getElementById('audit_user').value;
  const limit = document.getElementById('audit_limit').value;
  const status = document.getElementById('audit_status');
  const tbody = document.querySelector('#audit_table tbody');
  
  status.textContent = 'loading‚Ä¶';
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>';
  
  try {
    const r = await fetch(`/admin/api/users/transactions?user_id=${userId}&limit=${limit}`);
    const j = await r.json();
    if (!j.ok) throw new Error();
    
    const rows = j.transactions || [];
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No transactions found.</td></tr>';
      status.textContent = '0 rows';
      return;
    }
    
    tbody.innerHTML = rows.map(t => `
      <tr>
        <td>${t.id}</td>
        <td><span class="badge badge-success">${t.type}</span></td>
        <td>${t.delta > 0 ? '+' : ''}${t.delta}</td>
        <td>${t.reason || ''}</td>
        <td class="text-sm muted">${new Date(t.created_at).toLocaleString()}</td>
      </tr>
    `).join('');
    status.textContent = `‚úÖ ${rows.length} row(s)`;
  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="5" class="muted">Error loading data.</td></tr>';
    status.textContent = '‚ùå Error';
  }
});

// XP Audit
document.getElementById('xp_audit_load').addEventListener('click', async () => {
  const userId = document.getElementById('xp_audit_user').value;
  const limit = document.getElementById('xp_audit_limit').value;
  const status = document.getElementById('xp_audit_status');
  const tbody = document.querySelector('#xp_audit_table tbody');
  
  status.textContent = 'loading‚Ä¶';
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>';
  
  try {
    const r = await fetch(`/admin/api/users/xp/transactions?user_id=${userId}&limit=${limit}`);
    const j = await r.json();
    if (!j.ok) throw new Error();
    
    const rows = j.transactions || [];
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No XP transactions found.</td></tr>';
      status.textContent = '0 rows';
      return;
    }
    
    tbody.innerHTML = rows.map(t => `
      <tr>
        <td>${t.id}</td>
        <td>${t.delta > 0 ? '+' : ''}${t.delta}</td>
        <td>${t.reason || ''}</td>
        <td><code>${t.source || ''}</code></td>
        <td class="text-sm muted">${new Date(t.created_at).toLocaleString()}</td>
      </tr>
    `).join('');
    status.textContent = `‚úÖ ${rows.length} row(s)`;
  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="5" class="muted">Error loading data.</td></tr>';
    status.textContent = '‚ùå Error';
  }
});
</script>

{% endblock %}
