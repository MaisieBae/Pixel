{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Chat Console {% if sim_mode %}<span class="muted">(Sim mode)</span>{% else %}<span class="muted">(Live token set)</span>{% endif %}</h2>
  <form method="post" action="/admin/api/sim/chat" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <input name="user" placeholder="username" required />
    <input name="text" placeholder="message (e.g., !sound tada)" required />
    <button>Send</button>
  </form>
  <div class="muted" style="margin-top:6px">Tip: Try <code>!help</code></div>

  <h3 style="margin-top:16px">Inject Event</h3>
  <form method="post" action="/admin/api/sim/event" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <select name="kind">
      <option value="follow">follow</option>
      <option value="sub">sub</option>
      <option value="tip">tip</option>
      <option value="dropin">drop-in</option>
    </select>
    <input name="user" placeholder="username" />
    <input name="months" type="number" step="1" value="1" style="width:80px" />
    <input name="tokens" type="number" step="1" value="10" style="width:100px" />
    <button>Inject</button>
  </form>
</section>

<section class="card">
  <h2>Prize Wheel ‚Äî Quick Spin Tester <span class="muted">(admin only)</span></h2>
  <p class="muted">This bypasses points/cooldowns and enqueues a single <code>spin</code> job. Use for overlay testing.</p>
  <form id="quickspin" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <input name="user" placeholder="username" value="Tester" />
    <button type="submit">üé° Run Quick Spin</button>
    <span id="quickspin-result" class="muted"></span>
  </form>
  <script>
  (function(){
    const form = document.getElementById('quickspin');
    const out  = document.getElementById('quickspin-result');
    if(!form) return;
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      out.textContent = 'queuing‚Ä¶';
      const fd = new FormData(form);
      try{
        const token = new URLSearchParams(location.search).get('token') || '';
        const url = token ? ('/admin/api/spin/quick?token=' + encodeURIComponent(token)) : '/admin/api/spin/quick';
        const resp = await fetch(url, { method:'POST', body: fd });
        const data = await resp.json();
        if(data && data.ok) out.textContent = 'queued #' + data.queue_id;
        else out.textContent = 'error';
      }catch(err){
        out.textContent = 'error';
      }
    });
  })();
  </script>
</section>

<section class="card">
  <h2>Items <span class="muted">(inventory)</span></h2>
  <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
    <div style="flex:1; min-width:320px;">
      <h3>Create / Update Item</h3>
      <form method="post" action="/admin/api/items/upsert">
        <input name="key" placeholder="item key (e.g., confetti_token)" required />
        <input name="name" placeholder="display name" required />
        <input name="description" placeholder="description (optional)" />
        <input type="hidden" name="enabled" value="0" />
        <label><input type="checkbox" name="enabled" value="1" checked /> Enabled</label>
        <button type="submit">Save</button>
      </form>
      <p class="muted" style="margin-top:8px">Tip: Wheel prizes can grant items via <code>{"item_key":"confetti_token","item_qty":1}</code>.</p>
    </div>

    <div style="flex:1; min-width:320px;">
      <h3>Grant Item</h3>
      <form method="post" action="/admin/api/items/grant" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <input name="user" placeholder="username" required />
        <input name="item_key" placeholder="item key" required />
        <input name="qty" type="number" step="1" value="1" style="width:90px" />
        <button type="submit">Grant</button>
      </form>
      <div class="muted" style="margin-top:10px;">
        View inventory: <code>/admin/api/items/inventory?user=YOURNAME</code>
      </div>
    </div>
  </div>
</section>

<section class="card">
  <h2>Overlay SFX ‚Äî Quick Test</h2>
  <form id="playtest" hx-post="/admin/api/play-test" hx-target="#play-result" hx-swap="innerHTML">
    <button type="submit">‚ñ∂Ô∏è Play First Sound</button>
  </form>
  <div id="play-result" class="muted"></div>
</section>

<section class="card">
  <h2>Users & Points</h2>
  <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
    <div style="flex:1; min-width:260px;">
      <h3>Create User</h3>
      <form method="post" action="/admin/api/users/create">
        <input name="name" placeholder="username" required />
        <button type="submit">Create</button>
      </form>
    </div>
    <div style="flex:2; min-width:320px;">
      <h3>Recent Users</h3>
      {% if users %}
      <table>
        <thead><tr><th>User</th><th>Balance</th><th>Grant</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.name }}</td>
            <td>{{ u.points.balance if u.points else 0 }}</td>
            <td>
              <form method="post" action="/admin/api/users/grant" style="display:flex; gap:6px; align-items:center;">
                <input type="hidden" name="user_id" value="{{ u.id }}" />
                <input name="amount" type="number" step="1" style="width:90px" placeholder="amount" required />
                <input name="reason" style="width:160px" placeholder="reason" />
                <button>Grant</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h3 style="margin-top:16px">Manual Adjust (add or remove)</h3>
      <form method="post" action="/admin/api/users/adjust" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <input name="user" placeholder="username" required />
        <input name="delta" type="number" step="1" placeholder="delta (e.g., -50)" style="width:160px" required />
        <input name="reason" placeholder="reason" style="width:220px" />
        <button>Apply</button>
      </form>

      <div class="muted" style="margin-top:10px;">
        Audit JSON: <code>/admin/api/users/transactions</code> (optional <code>?user=NAME</code>)
      </div>
      {% else %}
        <p class="muted">No users yet. Create one above or use the Chat Console.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2>Audit Log <span class="muted">(last 50 transactions)</span></h2>
  {% if transactions %}
  <table>
    <thead><tr><th>ID</th><th>User ID</th><th>Type</th><th>Delta</th><th>Reason</th><th>Time (UTC)</th></tr></thead>
    <tbody>
      {% for t in transactions %}
      <tr>
        <td>{{ t.id }}</td>
        <td>{{ t.user_id }}</td>
        <td>{{ t.type }}</td>
        <td>{{ t.delta }}</td>
        <td>{{ t.reason }}</td>
        <td>{{ t.created_at }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p class="muted">No transactions yet.</p>
  {% endif %}
</section>

<section class="card">
  <h2>Redeems</h2>
  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div style="flex:1; min-width:320px;">
      <h3>Add / Update Redeem</h3>
      <form method="post" action="/admin/api/redeems/upsert">
        <input name="key" placeholder="key (e.g., tts)" required />
        <input name="display_name" placeholder="Display Name" required />
        <input name="cost" type="number" step="1" placeholder="Cost" required />
        <input name="cooldown_s" type="number" step="1" placeholder="Cooldown (seconds)" />
        <input type="hidden" name="enabled" value="0" />
        <label><input type="checkbox" name="enabled" value="1" checked /> Enabled</label>
        <button type="submit">Save</button>
      </form>
    </div>
    <div style="flex:2; min-width:360px;">
      <h3>Registered</h3>
      {% if redeems %}
      <table>
        <thead><tr><th>Key</th><th>Name</th><th>Cost</th><th>Cooldown</th><th>Enabled</th><th>Actions</th></tr></thead>
        <tbody>
        {% for r in redeems %}
          <tr>
            <td><code>{{ r.key }}</code></td>
            <td>{{ r.display_name }}</td>
            <td>{{ r.cost }}</td>
            <td>{{ r.cooldown_s }}</td>
            <td>{{ 'Yes' if r.enabled else 'No' }}</td>
            <td>
              <form method="post" action="/admin/api/redeems/toggle" style="display:inline-block">
                <input type="hidden" name="key" value="{{ r.key }}" />
                <input type="hidden" name="enabled" value="{{ 0 if r.enabled else 1 }}" />
                <button>{{ 'Disable' if r.enabled else 'Enable' }}</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="muted">No redeems found.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2>TTS Lines Editor <span class="muted">(live reload + backups)</span></h2>
  <p class="muted">Edits apply immediately: the wheel reads these files every spin. Saving creates a timestamped backup in <code>./data/backups/</code>.</p>

  <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
    <div style="flex:1; min-width:360px;">
      <h3>Spin Lines <span class="muted">(spin_lines.txt)</span></h3>
      <form method="post" action="/admin/api/tts-lines/save">
        <input type="hidden" name="kind" value="spin" />
        <textarea name="content" rows="10" style="width:100%;" spellcheck="false">{{ spin_lines_text }}</textarea>
        <button type="submit">Save Spin Lines</button>
      </form>
      <h4 style="margin-top:14px;">Backups</h4>
      {% if spin_line_backups %}
        <ul class="list">
          {% for b in spin_line_backups %}
          <li>
            <code>{{ b.name }}</code>
            <form method="post" action="/admin/api/tts-lines/restore" style="display:inline-block; margin-left:8px;">
              <input type="hidden" name="kind" value="spin" />
              <input type="hidden" name="backup_name" value="{{ b.name }}" />
              <button type="submit">Restore</button>
            </form>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No backups yet.</p>
      {% endif %}
    </div>

    <div style="flex:1; min-width:360px;">
      <h3>Prize Lines <span class="muted">(prize_lines.txt)</span></h3>
      <form method="post" action="/admin/api/tts-lines/save">
        <input type="hidden" name="kind" value="prize" />
        <textarea name="content" rows="10" style="width:100%;" spellcheck="false">{{ prize_lines_text }}</textarea>
        <button type="submit">Save Prize Lines</button>
      </form>
      <h4 style="margin-top:14px;">Backups</h4>
      {% if prize_line_backups %}
        <ul class="list">
          {% for b in prize_line_backups %}
          <li>
            <code>{{ b.name }}</code>
            <form method="post" action="/admin/api/tts-lines/restore" style="display:inline-block; margin-left:8px;">
              <input type="hidden" name="kind" value="prize" />
              <input type="hidden" name="backup_name" value="{{ b.name }}" />
              <button type="submit">Restore</button>
            </form>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No backups yet.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2>Queue</h2>
  <div id="queue-list" hx-get="/admin/api/queue" hx-trigger="load, every 2s" hx-swap="innerHTML">
    Loading‚Ä¶
  </div>
  <template id="qtpl">
    <table>
      <thead><tr><th>ID</th><th>Kind</th><th>Status</th><th>Created</th><th>Payload</th></tr></thead>
      <tbody></tbody>
    </table>
  </template>
  <script>
  (function(){
    const container = document.getElementById('queue-list');
    const render = (data) => {
      const tpl = document.getElementById('qtpl');
      const root = tpl.content.cloneNode(true);
      const tbody = root.querySelector('tbody');
      for (const it of (data.items||[])){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.id}</td><td>${it.kind}</td><td>${it.status}</td><td>${it.created_at}</td><td><code>${JSON.stringify(it.payload)}</code></td>`;
        tbody.appendChild(tr);
      }
      container.innerHTML = '';
      container.appendChild(root);
    };
    document.addEventListener('htmx:afterOnLoad', (ev)=>{
      try{ render(JSON.parse(ev.detail.xhr.responseText)); }catch(e){ /* ignore */ }
    });
  })();
  </script>
</section>

<section class="card">
  <h2>Available Sounds</h2>
  {% if sounds %}
    <ul class="list">
      {% for s in sounds %}
      <li>
        <code>{{ s }}</code>
        <button hx-post="/admin/api/play?name={{ s }}" hx-target="#play-result" hx-swap="innerHTML">Play</button>
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No sound files found in <code>./sounds</code>. Drop .wav/.mp3/.ogg files there.</p>
  {% endif %}
</section>
{% endblock %}
