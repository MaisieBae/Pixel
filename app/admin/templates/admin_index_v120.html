{% extends "base.html" %}
{% block content %}

<style>
  .card { background: #111827; border: 1px solid #1f2937; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
  .muted { color: #9ca3af; }
  .table { width: 100%; border-collapse: collapse; }
  .table th, .table td { border-bottom: 1px solid #1f2937; padding: 8px; text-align: left; vertical-align: top; }
  input, select, textarea { background: #0b1220; border: 1px solid #243047; color: #e5e7eb; padding: 6px 8px; border-radius: 8px; }
  button { background: #2563eb; border: none; color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
  button:hover { filter: brightness(1.05); }
</style>

<section class="card">
  <h2>Quick Spin Tester</h2>
  <form id="quickspin" method="post" action="/admin/api/spin/quick" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input name="user" placeholder="user" value="Tester" />
    <button type="submit">Queue spin</button>
    <span id="quickspin-result" class="muted"></span>
  </form>
</section>

<section class="card">
  <h2>TTS Lines Editor</h2>
  <p class="muted">Edits apply immediately for future spins/prizes. Backups are stored in <code>./data/backups</code>.</p>

  <form id="tts-lines-form" method="post" action="/admin/api/tts-lines/save" style="display:flex; gap:16px; flex-wrap:wrap;">
    <div style="flex:1; min-width:340px;">
      <h3>Spin Lines</h3>
      <textarea id="spin_lines" name="spin_lines" rows="12" style="width:100%;"></textarea>
      <div id="spin_backups" class="muted" style="margin-top:6px;"></div>
    </div>

    <div style="flex:1; min-width:340px;">
      <h3>Prize Lines</h3>
      <textarea id="prize_lines" name="prize_lines" rows="12" style="width:100%;"></textarea>
      <div id="prize_backups" class="muted" style="margin-top:6px;"></div>
    </div>

    <div style="flex-basis:100%; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button type="submit">Save</button>
      <span id="tts-save-result" class="muted"></span>
    </div>
  </form>

  <div style="margin-top:10px; display:flex; gap:20px; flex-wrap:wrap;">
    <form id="restore_spin" method="post" action="/admin/api/tts-lines/restore" style="display:flex; gap:10px; align-items:center;">
      <input type="hidden" name="which" value="spin"/>
      <input name="backup_name" placeholder="spin_lines_YYYYMMDD_HHMMSS.txt" style="min-width:280px;" />
      <button type="submit">Restore Spin</button>
      <span class="muted" id="restore_spin_result"></span>
    </form>

    <form id="restore_prize" method="post" action="/admin/api/tts-lines/restore" style="display:flex; gap:10px; align-items:center;">
      <input type="hidden" name="which" value="prize"/>
      <input name="backup_name" placeholder="prize_lines_YYYYMMDD_HHMMSS.txt" style="min-width:280px;" />
      <button type="submit">Restore Prize</button>
      <span class="muted" id="restore_prize_result"></span>
    </form>
  </div>
</section>

<section class="card">
  <h2>Users & Points</h2>

  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div style="flex:1; min-width:320px;">
      <h3>Create User</h3>
      <form method="post" action="/admin/api/users/create" style="display:flex; gap:8px; align-items:center;">
        <input name="name" placeholder="username" required />
        <button type="submit">Create</button>
      </form>
    </div>
  </div>

  <div style="margin-top:12px;">
    {% if users %}
      <table class="table">
        <thead>
          <tr>
            <th>User</th>
            <th>Last Seen</th>
            <th>Grant</th>
            <th>Adjust</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td><b>{{ u.name }}</b> (#{{ u.id }})</td>
            <td><code>{{ u.last_seen }}</code></td>
            <td>
              <form method="post" action="/admin/api/users/grant" style="display:flex; gap:6px; align-items:center;">
                <input type="hidden" name="user_id" value="{{ u.id }}" />
                <input name="amount" type="number" step="1" style="width:90px" placeholder="amount" required />
                <input name="reason" style="width:160px" placeholder="reason" />
                <button>Grant</button>
              </form>
            </td>
            <td>
              <form method="post" action="/admin/api/users/adjust" style="display:flex; gap:6px; align-items:center;">
                <input type="hidden" name="user_id" value="{{ u.id }}" />
                <input name="delta" type="number" step="1" style="width:90px" placeholder="+/-" required />
                <input name="reason" style="width:140px" placeholder="reason" value="admin_adjust" />
                <button>Apply</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No users yet. Create one above or use the Chat Console.</p>
    {% endif %}
  </div>
</section>

<section class="card">
  <h2>Audit Log</h2>
  <p class="muted">View recent point transactions (grant/spend/adjust) per user.</p>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <label>
      User:
      <select id="audit_user">
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.name }} (#{{ u.id }})</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Limit:
      <input id="audit_limit" type="number" step="1" value="50" style="width:90px" />
    </label>

    <button type="button" id="audit_load">Load</button>
    <span id="audit_status" class="muted"></span>
  </div>

  <div style="overflow:auto; margin-top:10px;">
    <table class="table" id="audit_table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Delta</th>
          <th>Reason</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5" class="muted">Click “Load”.</td></tr>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Redeems</h2>
  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div style="flex:1; min-width:320px;">
      <h3>Add / Update Redeem</h3>
      <form method="post" action="/admin/api/redeems/upsert">
        <input name="key" placeholder="key (e.g., tts)" required />
        <input name="display_name" placeholder="Display Name" required />
        <input name="cost" type="number" step="1" placeholder="Cost" required />
        <input name="cooldown_s" type="number" step="1" placeholder="Cooldown (sec)" value="0" />
        <label><input type="checkbox" name="enabled" value="1" checked /> Enabled</label>
        <button type="submit">Save</button>
      </form>
    </div>
    <div style="flex:2; min-width:360px;">
      <h3>Registered</h3>
      {% if redeems %}
      <table class="table">
        <thead>
          <tr>
            <th>Key</th><th>Name</th><th>Cost</th><th>Cooldown</th><th>Enabled</th><th>Toggle</th>
          </tr>
        </thead>
        <tbody>
          {% for r in redeems %}
          <tr>
            <td><code>{{ r.key }}</code></td>
            <td>{{ r.display_name }}</td>
            <td>{{ r.cost }}</td>
            <td>{{ r.cooldown_s if r.cooldown_s is defined else 0 }}s</td>
            <td>{{ 'Yes' if r.enabled else 'No' }}</td>
            <td>
              <form method="post" action="/admin/api/redeems/toggle" style="display:inline-block">
                <input type="hidden" name="key" value="{{ r.key }}" />
                <input type="hidden" name="enabled" value="{{ 0 if r.enabled else 1 }}" />
                <button>{{ 'Disable' if r.enabled else 'Enable' }}</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="muted">No redeems registered yet.</p>
      {% endif %}
    </div>
  </div>
</section>

<script>
  (function(){
    const form = document.getElementById('quickspin');
    const out  = document.getElementById('quickspin-result');
    if(!form) return;
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      out.textContent = 'queuing…';
      const fd = new FormData(form);
      try{
        const token = new URLSearchParams(location.search).get('token') || '';
        const url = token ? ('/admin/api/spin/quick?token=' + encodeURIComponent(token)) : '/admin/api/spin/quick';
        const resp = await fetch(url, { method:'POST', body: fd });
        const data = await resp.json();
        if(data && data.ok) out.textContent = 'queued #' + data.queue_id;
        else out.textContent = 'error';
      }catch(err){
        out.textContent = 'error';
      }
    });
  })();
</script>

<script>
  (function(){
    const token = new URLSearchParams(location.search).get('token') || '';
    const hdrs = token ? {'x-admin-token': token} : {};

    async function load(){
      const r = await fetch('/admin/api/tts-lines/get' + (token?('?token='+encodeURIComponent(token)):'') , {headers: hdrs});
      const j = await r.json();
      if(!j.ok) return;
      document.getElementById('spin_lines').value = j.spin_lines || '';
      document.getElementById('prize_lines').value = j.prize_lines || '';
      document.getElementById('spin_backups').textContent = 'Spin backups: ' + (j.spin_backups||[]).join(', ');
      document.getElementById('prize_backups').textContent = 'Prize backups: ' + (j.prize_backups||[]).join(', ');
    }

    document.getElementById('tts-lines-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = document.getElementById('tts-save-result');
      out.textContent = 'saving…';
      const fd = new FormData(e.target);
      try{
        const r = await fetch(e.target.action + (token?('?token='+encodeURIComponent(token)):'') , {method:'POST', body: fd, headers: hdrs});
        const j = await r.json();
        out.textContent = j.ok ? 'saved ✅' : ('error: ' + (j.detail||''));
        await load();
      }catch(err){ out.textContent = 'error: ' + err; }
    });

    document.getElementById('restore_spin').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = document.getElementById('restore_spin_result');
      out.textContent = 'restoring…';
      const fd = new FormData(e.target);
      try{
        const r = await fetch(e.target.action + (token?('?token='+encodeURIComponent(token)):'') , {method:'POST', body: fd, headers: hdrs});
        const j = await r.json();
        out.textContent = j.ok ? 'restored ✅' : ('error: ' + (j.detail||''));
        await load();
      }catch(err){ out.textContent = 'error: ' + err; }
    });

    document.getElementById('restore_prize').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = document.getElementById('restore_prize_result');
      out.textContent = 'restoring…';
      const fd = new FormData(e.target);
      try{
        const r = await fetch(e.target.action + (token?('?token='+encodeURIComponent(token)):'') , {method:'POST', body: fd, headers: hdrs});
        const j = await r.json();
        out.textContent = j.ok ? 'restored ✅' : ('error: ' + (j.detail||''));
        await load();
      }catch(err){ out.textContent = 'error: ' + err; }
    });

    load();
  })();
</script>

<script>
  (function(){
    const token = new URLSearchParams(location.search).get('token') || '';
    const hdrs = token ? {'x-admin-token': token} : {};

    const btn = document.getElementById('audit_load');
    const sel = document.getElementById('audit_user');
    const limitEl = document.getElementById('audit_limit');
    const status = document.getElementById('audit_status');
    const tbody = document.querySelector('#audit_table tbody');

    async function loadAudit(){
      if(!sel) return;
      const user_id = sel.value;
      const limit = limitEl && limitEl.value ? parseInt(limitEl.value, 10) : 50;
      status.textContent = 'loading…';
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';

      try{
        const qs = new URLSearchParams();
        qs.set('user_id', user_id);
        qs.set('limit', String(isNaN(limit) ? 50 : limit));
        if(token) qs.set('token', token);

        const r = await fetch('/admin/api/users/transactions?' + qs.toString(), {headers: hdrs});
        const j = await r.json();
        if(!j.ok){
          status.textContent = 'error';
          tbody.innerHTML = '<tr><td colspan="5" class="muted">Error.</td></tr>';
          return;
        }

        const rows = j.transactions || [];
        if(rows.length === 0){
          status.textContent = '0 rows';
          tbody.innerHTML = '<tr><td colspan="5" class="muted">No transactions.</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        for(const t of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.id}</td>
            <td>${t.type}</td>
            <td>${t.delta}</td>
            <td>${(t.reason||'')}</td>
            <td><code>${t.created_at}</code></td>
          `;
          tbody.appendChild(tr);
        }
        status.textContent = rows.length + ' row(s)';
      }catch(err){
        status.textContent = 'error';
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Error: ' + err + '</td></tr>';
      }
    }

    if(btn) btn.addEventListener('click', loadAudit);
  })();
</script>

{% endblock %}
