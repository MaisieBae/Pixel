<!-- Add this to the tab navigation (after line ~186) -->
<button class="tab" data-tab="batch">‚ö° Batch Operations</button>

<!-- Add this tab content section (after Settings tab, before closing container div) -->
<!-- Tab: Batch Operations -->
<div class="tab-content" id="tab-batch">
  <div class="grid grid-2">
    <!-- Batch Points -->
    <div class="card">
      <h2>‚ö° Batch Points Operation</h2>
      <p>Add or subtract points from multiple users at once. Useful for events, bonuses, or corrections.</p>
      
      <form id="batch-points-form" style="margin-top: 20px;">
        <div class="form-group">
          <label class="form-label">Operation *</label>
          <select name="operation" required>
            <option value="add">‚ûï Add Points</option>
            <option value="subtract">‚ûñ Subtract Points</option>
          </select>
          <small class="muted text-sm">Choose whether to add or remove points</small>
        </div>

        <div class="form-group">
          <label class="form-label">Amount *</label>
          <input type="number" name="amount" min="1" step="1" placeholder="100" required />
          <small class="muted text-sm">Number of points per user</small>
        </div>

        <div class="form-group">
          <label class="form-label">Target Users *</label>
          <select name="target" id="batch-points-target" required>
            <option value="all">üåê All Users</option>
            <option value="specific">üë§ Specific Users</option>
          </select>
        </div>

        <div class="form-group" id="batch-points-userids" style="display: none;">
          <label class="form-label">User IDs (comma-separated)</label>
          <input type="text" name="user_ids" placeholder="1, 2, 5, 10" />
          <small class="muted text-sm">Example: 1, 2, 3 or just: 5</small>
        </div>

        <div class="form-group">
          <label class="form-label">Reason</label>
          <input type="text" name="reason" placeholder="Event bonus" value="batch_admin" />
          <small class="muted text-sm">Appears in transaction logs</small>
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" name="allow_negative" value="true" />
            <span>Allow negative balances</span>
          </label>
          <small class="muted text-sm">‚ö†Ô∏è Only enable if you want users to go into debt</small>
        </div>

        <div style="display: flex; gap: 12px; align-items: center;">
          <button type="submit" class="btn btn-success">‚ö° Execute Batch Operation</button>
          <span class="status" id="batch-points-status"></span>
        </div>
      </form>

      <!-- Results Display -->
      <div id="batch-points-results" style="margin-top: 20px; display: none;">
        <h3 style="margin-bottom: 12px;">Results</h3>
        <div class="grid grid-3">
          <div class="stat-box">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" style="font-size: 28px;" id="bp-total">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label" style="color: var(--success);">Successful</div>
            <div class="stat-value" style="font-size: 28px; color: var(--success);" id="bp-success">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label" style="color: var(--danger);">Failed</div>
            <div class="stat-value" style="font-size: 28px; color: var(--danger);" id="bp-failed">-</div>
          </div>
        </div>
        <div id="bp-errors" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Batch XP -->
    <div class="card">
      <h2>‚ö° Batch XP Operation</h2>
      <p>Add or subtract XP from multiple users at once. May cause level changes.</p>
      
      <form id="batch-xp-form" style="margin-top: 20px;">
        <div class="form-group">
          <label class="form-label">Operation *</label>
          <select name="operation" required>
            <option value="add">‚ûï Add XP</option>
            <option value="subtract">‚ûñ Subtract XP</option>
          </select>
          <small class="muted text-sm">Choose whether to add or remove XP</small>
        </div>

        <div class="form-group">
          <label class="form-label">Amount *</label>
          <input type="number" name="amount" min="1" step="1" placeholder="500" required />
          <small class="muted text-sm">Amount of XP per user</small>
        </div>

        <div class="form-group">
          <label class="form-label">Target Users *</label>
          <select name="target" id="batch-xp-target" required>
            <option value="all">üåê All Users</option>
            <option value="specific">üë§ Specific Users</option>
          </select>
        </div>

        <div class="form-group" id="batch-xp-userids" style="display: none;">
          <label class="form-label">User IDs (comma-separated)</label>
          <input type="text" name="user_ids" placeholder="1, 2, 5, 10" />
          <small class="muted text-sm">Example: 1, 2, 3 or just: 5</small>
        </div>

        <div class="form-group">
          <label class="form-label">Reason</label>
          <input type="text" name="reason" placeholder="Event reward" value="batch_admin" />
          <small class="muted text-sm">Appears in XP transaction logs</small>
        </div>

        <div style="display: flex; gap: 12px; align-items: center;">
          <button type="submit" class="btn btn-primary">‚ö° Execute Batch Operation</button>
          <span class="status" id="batch-xp-status"></span>
        </div>
      </form>

      <!-- Results Display -->
      <div id="batch-xp-results" style="margin-top: 20px; display: none;">
        <h3 style="margin-bottom: 12px;">Results</h3>
        <div class="grid grid-3">
          <div class="stat-box">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" style="font-size: 28px;" id="bx-total">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label" style="color: var(--success);">Successful</div>
            <div class="stat-value" style="font-size: 28px; color: var(--success);" id="bx-success">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label" style="color: var(--danger);">Failed</div>
            <div class="stat-value" style="font-size: 28px; color: var(--danger);" id="bx-failed">-</div>
          </div>
        </div>
        
        <div id="bx-level-ups" style="margin-top: 16px;"></div>
        <div id="bx-errors" style="margin-top: 16px;"></div>
      </div>
    </div>
  </div>

  <!-- Warning Card -->
  <div class="card" style="border-color: var(--warning); background: rgba(245, 158, 11, 0.05);">
    <h3 style="color: var(--warning); margin-top: 0;">‚ö†Ô∏è Important Notes</h3>
    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
      <li><strong>All Users</strong> means EVERY user in your database will be affected</li>
      <li><strong>Specific Users</strong> only affects the user IDs you provide</li>
      <li>All operations are <strong>logged in the audit trail</strong></li>
      <li>Subtracting points may fail if users don't have enough (unless negative balances are allowed)</li>
      <li>XP changes may trigger level ups/downs and associated rewards</li>
      <li><strong>This action cannot be undone automatically</strong> - use with caution!</li>
    </ul>
  </div>
</div>

<!-- Add this JavaScript at the end of the existing <script> tag -->
<script>
// Batch Points - Show/Hide User IDs field
document.getElementById('batch-points-target').addEventListener('change', (e) => {
  const userIdsField = document.getElementById('batch-points-userids');
  userIdsField.style.display = e.target.value === 'specific' ? 'block' : 'none';
});

// Batch XP - Show/Hide User IDs field
document.getElementById('batch-xp-target').addEventListener('change', (e) => {
  const userIdsField = document.getElementById('batch-xp-userids');
  userIdsField.style.display = e.target.value === 'specific' ? 'block' : 'none';
});

// Batch Points Form Submit
document.getElementById('batch-points-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const status = document.getElementById('batch-points-status');
  const results = document.getElementById('batch-points-results');
  
  const formData = new FormData(e.target);
  const target = formData.get('target');
  const amount = formData.get('amount');
  
  // Confirm operation
  const msg = target === 'all' 
    ? `Are you sure you want to ${formData.get('operation')} ${amount} points to ALL users?`
    : `Are you sure you want to ${formData.get('operation')} ${amount} points to the selected users?`;
  
  if (!confirm(msg)) return;
  
  status.textContent = 'Processing...';
  status.style.color = 'var(--text-secondary)';
  results.style.display = 'none';
  
  try {
    const r = await fetch('/admin/api/users/batch-points', { method: 'POST', body: formData });
    const data = await r.json();
    
    if (!data.ok) {
      status.textContent = '‚ùå Error: ' + (data.error || 'Operation failed');
      status.style.color = 'var(--danger)';
      return;
    }
    
    // Show results
    document.getElementById('bp-total').textContent = data.total_users;
    document.getElementById('bp-success').textContent = data.success;
    document.getElementById('bp-failed').textContent = data.failed;
    
    // Show errors if any
    const errDiv = document.getElementById('bp-errors');
    if (data.errors && data.errors.length > 0) {
      errDiv.innerHTML = '<h4 style="color: var(--danger);">Errors:</h4>' +
        '<ul style="color: var(--danger);">' +
        data.errors.map(e => `<li>${e.user_name} (ID: ${e.user_id}): ${e.error}</li>`).join('') +
        '</ul>';
    } else {
      errDiv.innerHTML = '';
    }
    
    results.style.display = 'block';
    status.textContent = '‚úÖ Operation completed';
    status.style.color = 'var(--success)';
    
    // Refresh after 2 seconds
    setTimeout(() => { location.reload(); }, 2000);
  } catch (err) {
    status.textContent = '‚ùå Error: ' + err.message;
    status.style.color = 'var(--danger)';
  }
});

// Batch XP Form Submit
document.getElementById('batch-xp-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const status = document.getElementById('batch-xp-status');
  const results = document.getElementById('batch-xp-results');
  
  const formData = new FormData(e.target);
  const target = formData.get('target');
  const amount = formData.get('amount');
  
  // Confirm operation
  const msg = target === 'all' 
    ? `Are you sure you want to ${formData.get('operation')} ${amount} XP to ALL users?`
    : `Are you sure you want to ${formData.get('operation')} ${amount} XP to the selected users?`;
  
  if (!confirm(msg)) return;
  
  status.textContent = 'Processing...';
  status.style.color = 'var(--text-secondary)';
  results.style.display = 'none';
  
  try {
    const r = await fetch('/admin/api/users/batch-xp', { method: 'POST', body: formData });
    const data = await r.json();
    
    if (!data.ok) {
      status.textContent = '‚ùå Error: ' + (data.error || 'Operation failed');
      status.style.color = 'var(--danger)';
      return;
    }
    
    // Show results
    document.getElementById('bx-total').textContent = data.total_users;
    document.getElementById('bx-success').textContent = data.success;
    document.getElementById('bx-failed').textContent = data.failed;
    
    // Show level ups if any
    const levelDiv = document.getElementById('bx-level-ups');
    if (data.level_ups && data.level_ups.length > 0) {
      levelDiv.innerHTML = '<h4 style="color: var(--success);">üéâ Level Changes:</h4>' +
        '<ul style="color: var(--success);">' +
        data.level_ups.map(l => `<li><strong>${l.user_name}</strong>: Level ${l.level_before} ‚Üí ${l.level_after}</li>`).join('') +
        '</ul>';
    } else {
      levelDiv.innerHTML = '';
    }
    
    // Show errors if any
    const errDiv = document.getElementById('bx-errors');
    if (data.errors && data.errors.length > 0) {
      errDiv.innerHTML = '<h4 style="color: var(--danger);">Errors:</h4>' +
        '<ul style="color: var(--danger);">' +
        data.errors.map(e => `<li>${e.user_name} (ID: ${e.user_id}): ${e.error}</li>`).join('') +
        '</ul>';
    } else {
      errDiv.innerHTML = '';
    }
    
    results.style.display = 'block';
    status.textContent = '‚úÖ Operation completed';
    status.style.color = 'var(--success)';
    
    // Refresh after 2 seconds
    setTimeout(() => { location.reload(); }, 2000);
  } catch (err) {
    status.textContent = '‚ùå Error: ' + err.message;
    status.style.color = 'var(--danger)';
  }
});
</script>
